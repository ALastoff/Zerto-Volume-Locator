
name: CI

on:
  push:
  pull_request:

jobs:
  lint:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: |
          Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
          Install-Module PSScriptAnalyzer -Force -Scope CurrentUser

      - name: Analyze PowerShell scripts
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          # Find all PS scripts
          $paths = Get-ChildItem -Path . -Recurse -Include *.ps1,*.psm1

          if (-not $paths) {
            Write-Host "No PowerShell scripts found. Skipping."
            exit 0
          }

          # Run analyzer
          $issues = Invoke-ScriptAnalyzer -Path $paths.FullName -Severity Error,Warning -ReportSummary

          if ($issues) {
            $issues | Format-Table RuleName,Severity,ScriptPath,Line,Message -AutoSize
            # Fail only on Errors; allow Warnings to pass (optional)
            $errors = $issues | Where-Object Severity -eq 'Error'
            if ($errors) { exit 1 } else { Write-Host "Warnings found; not failing." }
          } else {
            Write-Host "No issues"            
            Write-Host "No issues found."
